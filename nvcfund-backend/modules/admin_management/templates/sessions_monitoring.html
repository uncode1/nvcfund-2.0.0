{% extends "base.html" %}

{% block title %}Active Sessions Monitoring - NVC Banking Platform{% endblock %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
    .sessions-monitoring {
        background: linear-gradient(135deg, #0a2447 0%, #1a365d 100%);
        min-height: 100vh;
        color: #ffffff;
        padding: 20px;
    }
    
    .monitoring-header {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .session-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-box {
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        transition: all 0.3s ease;
    }
    
    .stat-box:hover {
        background: rgba(255,255,255,0.15);
        transform: translateY(-3px);
    }
    
    .stat-icon {
        font-size: 2rem;
        color: #66ccff;
        margin-bottom: 10px;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #66ccff;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .active-sessions {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .sessions-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .sessions-table th,
    .sessions-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .sessions-table th {
        background: rgba(255,255,255,0.1);
        font-weight: bold;
        color: #66ccff;
        position: sticky;
        top: 0;
    }
    
    .sessions-table tbody tr:hover {
        background: rgba(255,255,255,0.05);
    }
    
    .session-row {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .session-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
    }
    
    .status-active { background: #00ff88; color: #000; }
    .status-idle { background: #ffaa00; color: #000; }
    .status-expired { background: #ff4444; color: #fff; }
    .status-suspicious { background: #ff6b6b; color: #fff; }
    
    .role-badge {
        padding: 3px 6px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    
    .role-admin { background: #ff4757; color: #fff; }
    .role-treasury { background: #3742fa; color: #fff; }
    .role-business { background: #2ed573; color: #fff; }
    .role-standard { background: #747d8c; color: #fff; }
    
    .location-info {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
    }
    
    .device-info {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .action-btn {
        background: #66ccff;
        color: #0a2447;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .action-btn:hover {
        background: #4db8ff;
        transform: scale(1.05);
    }
    
    .action-btn.danger {
        background: #ff4444;
        color: #fff;
    }
    
    .action-btn.danger:hover {
        background: #ff3333;
    }
    
    .session-charts {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .chart-container {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .security-alerts {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .alert-item {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .alert-high { border-left-color: #ff4444; }
    .alert-medium { border-left-color: #ffaa00; }
    .alert-low { border-left-color: #00ff88; }
    
    .alert-content {
        flex: 1;
    }
    
    .alert-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .alert-description {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .filters-container {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-input,
    .filter-select {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px;
        color: #fff;
        min-width: 150px;
    }
    
    .filter-input::placeholder {
        color: rgba(255,255,255,0.6);
    }
    
    .realtime-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }
    
    .realtime-dot {
        width: 8px;
        height: 8px;
        background: #00ff88;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .session-details-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
    }
    
    .modal-content {
        background: linear-gradient(135deg, #0a2447 0%, #1a365d 100%);
        margin: 3% auto;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 800px;
        border: 1px solid rgba(255,255,255,0.2);
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #fff;
    }
    
    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .detail-section {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
    }
    
    .detail-title {
        font-weight: bold;
        color: #66ccff;
        margin-bottom: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding-bottom: 5px;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        padding: 5px 0;
    }
    
    .detail-label {
        font-weight: bold;
        opacity: 0.8;
    }
    
    .detail-value {
        color: #66ccff;
    }
    
    .activity-timeline {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .timeline-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .timeline-time {
        font-size: 0.8rem;
        opacity: 0.7;
        min-width: 80px;
    }
    
    .timeline-event {
        flex: 1;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="sessions-monitoring">
    <!-- Monitoring Header -->
    <div class="monitoring-header">
        <div>
            <h1><i class="fas fa-users"></i> Active Sessions Monitoring</h1>
            <p>Real-time session tracking with granular drill-down capabilities</p>
        </div>
        <div class="realtime-indicator">
            <span class="realtime-dot"></span>
            <span>Live Monitoring</span>
        </div>
    </div>

    <!-- Session Statistics -->
    <div class="session-stats">
        <div class="stat-box">
            <div class="stat-icon"><i class="fas fa-circle text-success"></i></div>
            <div class="stat-number" id="active-sessions">{{ sessions_data.active_sessions or 0 }}</div>
            <div class="stat-label">Active Sessions</div>
        </div>
        
        <div class="stat-box">
            <div class="stat-icon"><i class="fas fa-clock text-warning"></i></div>
            <div class="stat-number" id="idle-sessions">{{ sessions_data.idle_sessions or 0 }}</div>
            <div class="stat-label">Idle Sessions</div>
        </div>
        
        <div class="stat-box">
            <div class="stat-icon"><i class="fas fa-exclamation-triangle text-danger"></i></div>
            <div class="stat-number" id="suspicious-sessions">{{ sessions_data.suspicious_sessions or 0 }}</div>
            <div class="stat-label">Suspicious Sessions</div>
        </div>
        
        <div class="stat-box">
            <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
            <div class="stat-number" id="avg-duration">{{ sessions_data.avg_duration or '0m' }}</div>
            <div class="stat-label">Avg Duration</div>
        </div>
        
        <div class="stat-box">
            <div class="stat-icon"><i class="fas fa-globe"></i></div>
            <div class="stat-number" id="unique-locations">{{ sessions_data.unique_locations or 0 }}</div>
            <div class="stat-label">Unique Locations</div>
        </div>
        
        <div class="stat-box">
            <div class="stat-icon"><i class="fas fa-mobile-alt"></i></div>
            <div class="stat-number" id="mobile-sessions">{{ sessions_data.mobile_sessions or 0 }}</div>
            <div class="stat-label">Mobile Sessions</div>
        </div>
    </div>

    <!-- Session Charts -->
    <div class="session-charts">
        <div class="chart-container">
            <h3><i class="fas fa-chart-area"></i> Session Activity Over Time</h3>
            <canvas id="sessionActivityChart" width="400" height="300"></canvas>
        </div>
        
        <div class="chart-container">
            <h3><i class="fas fa-chart-pie"></i> Session Distribution by Role</h3>
            <canvas id="sessionRoleChart" width="400" height="300"></canvas>
        </div>
    </div>

    <!-- Security Alerts -->
    <div class="security-alerts">
        <h3><i class="fas fa-shield-alt"></i> Session Security Alerts</h3>
        <div id="security-alerts-container">
            {% if sessions_data.security_alerts %}
                {% for alert in sessions_data.security_alerts %}
                <div class="alert-item alert-{{ alert.severity.lower() }}">
                    <div class="alert-content">
                        <div class="alert-title">{{ alert.title }}</div>
                        <div class="alert-description">{{ alert.description }}</div>
                        <small>{{ alert.timestamp }}</small>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="investigateAlert('{{ alert.id }}')">Investigate</button>
                        <button class="action-btn danger" onclick="blockSession('{{ alert.session_id }}')">Block</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert-item alert-low">
                    <div class="alert-content">
                        <div class="alert-title">No Security Alerts</div>
                        <div class="alert-description">All sessions are operating normally</div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Active Sessions Table -->
    <div class="active-sessions">
        <div class="filters-container">
            <input type="text" class="filter-input" id="session-search" placeholder="Search by user, IP, or session ID...">
            <select class="filter-select" id="status-filter">
                <option value="">All Statuses</option>
                <option value="active">Active</option>
                <option value="idle">Idle</option>
                <option value="suspicious">Suspicious</option>
            </select>
            <select class="filter-select" id="role-filter">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="treasury">Treasury</option>
                <option value="business">Business</option>
                <option value="standard">Standard</option>
            </select>
            <button class="action-btn" onclick="refreshSessions()">
                <i class="fas fa-sync"></i> Refresh
            </button>
            <button class="action-btn" onclick="exportSessions()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>

        <table class="sessions-table">
            <thead>
                <tr>
                    <th>Session ID</th>
                    <th>User</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Location</th>
                    <th>Device</th>
                    <th>Started</th>
                    <th>Last Activity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="sessions-table-body">
                {% if sessions_data.sessions %}
                    {% for session in sessions_data.sessions %}
                    <tr class="session-row" data-session-id="{{ session.id }}" onclick="viewSessionDetails('{{ session.id }}')">
                        <td><code>{{ session.id[:8] }}...</code></td>
                        <td>{{ session.username }}</td>
                        <td><span class="role-badge role-{{ session.role.lower() }}">{{ session.role }}</span></td>
                        <td><span class="session-status status-{{ session.status.lower() }}">{{ session.status }}</span></td>
                        <td>
                            <div class="location-info">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ session.location }}
                            </div>
                        </td>
                        <td>
                            <div class="device-info">
                                <i class="fas fa-{{ 'mobile' if session.is_mobile else 'desktop' }}"></i>
                                {{ session.device }}
                            </div>
                        </td>
                        <td>{{ session.started_at }}</td>
                        <td>{{ session.last_activity }}</td>
                        <td onclick="event.stopPropagation()">
                            <div class="action-buttons">
                                <button class="action-btn" onclick="viewSessionDetails('{{ session.id }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="messageUser('{{ session.user_id }}')">
                                    <i class="fas fa-comment"></i>
                                </button>
                                <button class="action-btn danger" onclick="terminateSession('{{ session.id }}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 30px; opacity: 0.7;">
                            No active sessions found
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Session Details Modal -->
<div id="sessionModal" class="session-details-modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2><i class="fas fa-user-clock"></i> Session Details</h2>
        <div id="session-details-content">
            <!-- Session details will be loaded here -->
        </div>
    </div>
</div>

<script>
// Socket.IO connection for real-time session monitoring
const socket = io('/admin-management');

// Chart instances
let sessionActivityChart, sessionRoleChart;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupEventListeners();
    
    // Connect to socket for real-time updates
    if (socket.connected) {
        socket.emit('request_sessions_data');
    }
});

// Socket event handlers
socket.on('connect', function() {
    console.log('Connected to admin management socket for sessions monitoring');
    socket.emit('request_sessions_data');
});

socket.on('sessions_update', function(data) {
    updateSessionsData(data);
});

socket.on('session_activity_update', function(data) {
    updateSessionActivityChart(data);
});

socket.on('session_terminated', function(data) {
    removeSessionFromTable(data.session_id);
    updateSessionStats();
});

socket.on('new_session', function(session) {
    addSessionToTable(session);
    updateSessionStats();
});

socket.on('session_security_alert', function(alert) {
    addSecurityAlert(alert);
});

// Initialize charts
function initializeCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: '#ffffff' }
            }
        },
        scales: {
            x: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    };

    // Session Activity Chart
    const activityCtx = document.getElementById('sessionActivityChart').getContext('2d');
    sessionActivityChart = new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Active Sessions',
                    data: [],
                    borderColor: '#66ccff',
                    backgroundColor: 'rgba(102, 204, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'New Sessions',
                    data: [],
                    borderColor: '#00ff88',
                    backgroundColor: 'rgba(0, 255, 136, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: chartOptions
    });

    // Session Role Distribution Chart
    const roleCtx = document.getElementById('sessionRoleChart').getContext('2d');
    sessionRoleChart = new Chart(roleCtx, {
        type: 'doughnut',
        data: {
            labels: ['Admin', 'Treasury', 'Business', 'Standard'],
            datasets: [{
                data: [15, 25, 35, 125],
                backgroundColor: [
                    '#ff4757',
                    '#3742fa',
                    '#2ed573',
                    '#747d8c'
                ],
                borderWidth: 2,
                borderColor: '#0a2447'
            }]
        },
        options: {
            ...chartOptions,
            scales: {} // Remove scales for doughnut chart
        }
    });
}

// Setup event listeners
function setupEventListeners() {
    // Search input
    document.getElementById('session-search').addEventListener('input', function(e) {
        filterSessions();
    });
    
    // Status filter
    document.getElementById('status-filter').addEventListener('change', function(e) {
        filterSessions();
    });
    
    // Role filter
    document.getElementById('role-filter').addEventListener('change', function(e) {
        filterSessions();
    });
    
    // Modal close
    document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('sessionModal').style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
        const modal = document.getElementById('sessionModal');
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
}

// Update functions
function updateSessionsData(data) {
    document.getElementById('active-sessions').textContent = data.active_sessions || 0;
    document.getElementById('idle-sessions').textContent = data.idle_sessions || 0;
    document.getElementById('suspicious-sessions').textContent = data.suspicious_sessions || 0;
    document.getElementById('avg-duration').textContent = data.avg_duration || '0m';
    document.getElementById('unique-locations').textContent = data.unique_locations || 0;
    document.getElementById('mobile-sessions').textContent = data.mobile_sessions || 0;
    
    if (data.sessions) {
        updateSessionsTable(data.sessions);
    }
}

function updateSessionActivityChart(data) {
    if (sessionActivityChart && data.labels) {
        sessionActivityChart.data.labels = data.labels;
        sessionActivityChart.data.datasets[0].data = data.active_sessions || [];
        sessionActivityChart.data.datasets[1].data = data.new_sessions || [];
        sessionActivityChart.update('none');
    }
}

function updateSessionsTable(sessions) {
    const tbody = document.getElementById('sessions-table-body');
    tbody.innerHTML = '';
    
    if (sessions && sessions.length > 0) {
        sessions.forEach(session => {
            const row = createSessionRow(session);
            tbody.appendChild(row);
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px; opacity: 0.7;">No active sessions found</td></tr>';
    }
}

function createSessionRow(session) {
    const row = document.createElement('tr');
    row.className = 'session-row';
    row.setAttribute('data-session-id', session.id);
    row.onclick = () => viewSessionDetails(session.id);
    
    row.innerHTML = `
        <td><code>${session.id.substring(0, 8)}...</code></td>
        <td>${session.username}</td>
        <td><span class="role-badge role-${session.role.toLowerCase()}">${session.role}</span></td>
        <td><span class="session-status status-${session.status.toLowerCase()}">${session.status}</span></td>
        <td>
            <div class="location-info">
                <i class="fas fa-map-marker-alt"></i>
                ${session.location}
            </div>
        </td>
        <td>
            <div class="device-info">
                <i class="fas fa-${session.is_mobile ? 'mobile' : 'desktop'}"></i>
                ${session.device}
            </div>
        </td>
        <td>${session.started_at}</td>
        <td>${session.last_activity}</td>
        <td onclick="event.stopPropagation()">
            <div class="action-buttons">
                <button class="action-btn" onclick="viewSessionDetails('${session.id}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn" onclick="messageUser('${session.user_id}')">
                    <i class="fas fa-comment"></i>
                </button>
                <button class="action-btn danger" onclick="terminateSession('${session.id}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

function addSessionToTable(session) {
    const tbody = document.getElementById('sessions-table-body');
    const row = createSessionRow(session);
    tbody.insertBefore(row, tbody.firstChild);
}

function removeSessionFromTable(sessionId) {
    const row = document.querySelector(`tr[data-session-id="${sessionId}"]`);
    if (row) {
        row.remove();
    }
}

function addSecurityAlert(alert) {
    const container = document.getElementById('security-alerts-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert-item alert-${alert.severity.toLowerCase()}`;
    alertDiv.innerHTML = `
        <div class="alert-content">
            <div class="alert-title">${alert.title}</div>
            <div class="alert-description">${alert.description}</div>
            <small>${alert.timestamp}</small>
        </div>
        <div class="action-buttons">
            <button class="action-btn" onclick="investigateAlert('${alert.id}')">Investigate</button>
            <button class="action-btn danger" onclick="blockSession('${alert.session_id}')">Block</button>
        </div>
    `;
    
    // Add to top of alerts
    container.insertBefore(alertDiv, container.firstChild);
    
    // Keep only latest 10 alerts
    while (container.children.length > 10) {
        container.removeChild(container.lastChild);
    }
}

// Action functions
function viewSessionDetails(sessionId) {
    fetch(`/admin/api/sessions/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSessionDetailsModal(data.session);
            } else {
                alert('Error loading session details: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading session details');
        });
}

function showSessionDetailsModal(session) {
    const modal = document.getElementById('sessionModal');
    const content = document.getElementById('session-details-content');
    
    content.innerHTML = `
        <div class="detail-grid">
            <div class="detail-section">
                <div class="detail-title">Session Information</div>
                <div class="detail-item">
                    <span class="detail-label">Session ID:</span>
                    <span class="detail-value">${session.id}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">User:</span>
                    <span class="detail-value">${session.username}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Role:</span>
                    <span class="detail-value">${session.role}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Status:</span>
                    <span class="detail-value">${session.status}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Duration:</span>
                    <span class="detail-value">${session.duration}</span>
                </div>
            </div>
            
            <div class="detail-section">
                <div class="detail-title">Technical Details</div>
                <div class="detail-item">
                    <span class="detail-label">IP Address:</span>
                    <span class="detail-value">${session.ip_address}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">User Agent:</span>
                    <span class="detail-value">${session.user_agent}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value">${session.location}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Device:</span>
                    <span class="detail-value">${session.device}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Browser:</span>
                    <span class="detail-value">${session.browser}</span>
                </div>
            </div>
        </div>
        
        <div class="detail-section">
            <div class="detail-title">Activity Timeline</div>
            <div class="activity-timeline" id="session-timeline">
                Loading activity timeline...
            </div>
        </div>
    `;
    
    modal.style.display = 'block';
    
    // Load session activity timeline
    loadSessionTimeline(session.id);
}

function loadSessionTimeline(sessionId) {
    fetch(`/admin/api/sessions/${sessionId}/timeline`)
        .then(response => response.json())
        .then(data => {
            const timeline = document.getElementById('session-timeline');
            if (data.success && data.timeline.length > 0) {
                timeline.innerHTML = data.timeline.map(event => `
                    <div class="timeline-item">
                        <div class="timeline-time">${event.time}</div>
                        <div class="timeline-event">${event.description}</div>
                    </div>
                `).join('');
            } else {
                timeline.innerHTML = '<p>No activity recorded</p>';
            }
        })
        .catch(error => {
            document.getElementById('session-timeline').innerHTML = '<p>Error loading timeline</p>';
        });
}

function terminateSession(sessionId) {
    if (confirm('Are you sure you want to terminate this session?')) {
        fetch(`/admin/api/sessions/${sessionId}/terminate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Session terminated successfully');
                // Real-time update will handle the UI update
            } else {
                alert('Error terminating session: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error terminating session');
        });
    }
}

function messageUser(userId) {
    const message = prompt('Enter message for user:');
    if (message) {
        fetch(`/admin/api/users/${userId}/message`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Message sent successfully');
            } else {
                alert('Error sending message: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error sending message');
        });
    }
}

function investigateAlert(alertId) {
    window.location.href = `/admin/security/alerts/${alertId}/investigate`;
}

function blockSession(sessionId) {
    if (confirm('Are you sure you want to block this session?')) {
        terminateSession(sessionId);
    }
}

function filterSessions() {
    const search = document.getElementById('session-search').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    const roleFilter = document.getElementById('role-filter').value;
    
    const rows = document.querySelectorAll('#sessions-table-body tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const status = row.querySelector('.session-status')?.textContent.toLowerCase();
        const role = row.querySelector('.role-badge')?.textContent.toLowerCase();
        
        const matchesSearch = !search || text.includes(search);
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesRole = !roleFilter || role === roleFilter;
        
        row.style.display = matchesSearch && matchesStatus && matchesRole ? '' : 'none';
    });
}

function refreshSessions() {
    socket.emit('request_sessions_refresh');
}

function exportSessions() {
    window.location.href = '/admin/sessions/export';
}

function updateSessionStats() {
    socket.emit('request_sessions_stats');
}
</script>
{% endblock %}