{% extends "base.html" %}

{% block title %}Admin Management Dashboard - NVC Banking Platform{% endblock %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
    .admin-dashboard {
        background: linear-gradient(135deg, #0a2447 0%, #1a365d 100%);
        min-height: 100vh;
        color: #ffffff;
        padding: 20px;
    }
    
    .dashboard-header {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .metric-card:hover {
        background: rgba(255,255,255,0.15);
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .metric-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #66ccff;
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: #66ccff;
    }
    
    .metric-label {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    .chart-container {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .realtime-indicator {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 12px;
        height: 12px;
        background: #00ff88;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .data-table {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .data-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .data-table th {
        background: rgba(255,255,255,0.1);
        font-weight: bold;
        color: #66ccff;
    }
    
    .status-indicator {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
    }
    
    .status-healthy { background: #00ff88; color: #000; }
    .status-warning { background: #ffaa00; color: #000; }
    .status-critical { background: #ff4444; color: #fff; }
    
    .drill-down-btn {
        background: #66ccff;
        color: #0a2447;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .drill-down-btn:hover {
        background: #4db8ff;
        transform: scale(1.05);
    }
    
    .alert-panel {
        background: rgba(255,68,68,0.2);
        border-left: 4px solid #ff4444;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
    }
    
    .success-panel {
        background: rgba(0,255,136,0.2);
        border-left: 4px solid #00ff88;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="realtime-indicator" title="Real-time Data Stream Active"></div>
        <h1><i class="fas fa-tachometer-alt"></i> Admin Management Dashboard</h1>
        <p>Real-time system monitoring and administrative controls</p>
        <div id="last-update">Last Updated: <span id="update-timestamp">{{ dashboard_data.timestamp }}</span></div>
    </div>

    <!-- System Alerts -->
    <div id="alert-container">
        {% if dashboard_data.alerts %}
            {% for alert in dashboard_data.alerts %}
                <div class="alert-panel">
                    <strong><i class="fas fa-exclamation-triangle"></i> {{ alert.type }}:</strong> {{ alert.message }}
                    <button class="drill-down-btn" onclick="drillDownAlert('{{ alert.id }}')">View Details</button>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Key Metrics Grid -->
    <div class="metrics-grid">
        <div class="metric-card" onclick="drillDownUsers()">
            <div class="metric-icon"><i class="fas fa-users"></i></div>
            <div class="metric-value" id="total-users">{{ dashboard_data.total_users or 0 }}</div>
            <div class="metric-label">Total Users</div>
        </div>
        
        <div class="metric-card" onclick="drillDownSessions()">
            <div class="metric-icon"><i class="fas fa-user-clock"></i></div>
            <div class="metric-value" id="active-sessions">{{ dashboard_data.active_sessions or 0 }}</div>
            <div class="metric-label">Active Sessions</div>
        </div>
        
        <div class="metric-card" onclick="drillDownTransactions()">
            <div class="metric-icon"><i class="fas fa-exchange-alt"></i></div>
            <div class="metric-value" id="daily-transactions">{{ dashboard_data.daily_transactions or 0 }}</div>
            <div class="metric-label">Today's Transactions</div>
        </div>
        
        <div class="metric-card" onclick="drillDownSystem()">
            <div class="metric-icon"><i class="fas fa-server"></i></div>
            <div class="metric-value" id="system-load">{{ dashboard_data.system_load or '0%' }}</div>
            <div class="metric-label">System Load</div>
        </div>
        
        <div class="metric-card" onclick="drillDownSecurity()">
            <div class="metric-icon"><i class="fas fa-shield-alt"></i></div>
            <div class="metric-value" id="security-score">{{ dashboard_data.security_score or '0%' }}</div>
            <div class="metric-label">Security Score</div>
        </div>
        
        <div class="metric-card" onclick="drillDownBackups()">
            <div class="metric-icon"><i class="fas fa-database"></i></div>
            <div class="metric-value" id="last-backup">{{ dashboard_data.last_backup_hours or 'N/A' }}</div>
            <div class="metric-label">Hours Since Backup</div>
        </div>
    </div>

    <!-- Real-time Charts -->
    <div class="chart-container">
        <h3><i class="fas fa-chart-line"></i> Real-time System Performance</h3>
        <canvas id="systemPerformanceChart" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
        <h3><i class="fas fa-users-cog"></i> User Activity Trends</h3>
        <canvas id="userActivityChart" width="400" height="200"></canvas>
    </div>

    <!-- Recent Activity Table -->
    <div class="data-table">
        <h3 style="padding: 20px; margin: 0;"><i class="fas fa-history"></i> Recent Administrative Actions</h3>
        <table>
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Administrator</th>
                    <th>Action</th>
                    <th>Target</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="recent-actions">
                {% if dashboard_data.recent_actions %}
                    {% for action in dashboard_data.recent_actions %}
                    <tr>
                        <td>{{ action.timestamp }}</td>
                        <td>{{ action.admin_user }}</td>
                        <td>{{ action.action_type }}</td>
                        <td>{{ action.target }}</td>
                        <td>
                            <span class="status-indicator status-{{ action.status }}">{{ action.status.title() }}</span>
                        </td>
                        <td>
                            <button class="drill-down-btn" onclick="drillDownAction('{{ action.id }}')">View</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; opacity: 0.7;">
                            No recent administrative actions
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- System Health Status -->
    <div class="data-table">
        <h3 style="padding: 20px; margin: 0;"><i class="fas fa-heartbeat"></i> System Health Status</h3>
        <table>
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Status</th>
                    <th>Last Check</th>
                    <th>Response Time</th>
                    <th>Uptime</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="system-health">
                {% if dashboard_data.system_components %}
                    {% for component in dashboard_data.system_components %}
                    <tr>
                        <td>{{ component.name }}</td>
                        <td>
                            <span class="status-indicator status-{{ component.status }}">{{ component.status.title() }}</span>
                        </td>
                        <td>{{ component.last_check }}</td>
                        <td>{{ component.response_time }}ms</td>
                        <td>{{ component.uptime }%}</td>
                        <td>
                            <button class="drill-down-btn" onclick="drillDownComponent('{{ component.id }}')">Monitor</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
// Socket.IO connection for real-time updates
const socket = io('/admin-management');

// Chart configurations
let systemChart, userChart;

// Initialize charts
function initializeCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: '#ffffff'
                }
            }
        },
        scales: {
            x: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    };

    // System Performance Chart
    const systemCtx = document.getElementById('systemPerformanceChart').getContext('2d');
    systemChart = new Chart(systemCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CPU Usage (%)',
                    data: [],
                    borderColor: '#66ccff',
                    backgroundColor: 'rgba(102, 204, 255, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Memory Usage (%)',
                    data: [],
                    borderColor: '#ff6b6b',
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Network I/O (MB/s)',
                    data: [],
                    borderColor: '#4ecdc4',
                    backgroundColor: 'rgba(78, 205, 196, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: chartOptions
    });

    // User Activity Chart
    const userCtx = document.getElementById('userActivityChart').getContext('2d');
    userChart = new Chart(userCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Active Users',
                    data: [],
                    backgroundColor: '#66ccff',
                    borderColor: '#4db8ff',
                    borderWidth: 2
                },
                {
                    label: 'New Registrations',
                    data: [],
                    backgroundColor: '#ff6b6b',
                    borderColor: '#ff5252',
                    borderWidth: 2
                }
            ]
        },
        options: chartOptions
    });
}

// Socket event handlers
socket.on('connect', function() {
    console.log('Connected to admin management socket');
    socket.emit('request_dashboard_data');
});

socket.on('dashboard_update', function(data) {
    updateDashboard(data);
});

socket.on('system_metrics', function(data) {
    updateSystemChart(data);
});

socket.on('user_activity', function(data) {
    updateUserChart(data);
});

socket.on('new_alert', function(alert) {
    addAlert(alert);
});

socket.on('admin_action', function(action) {
    addRecentAction(action);
});

socket.on('component_status', function(component) {
    updateComponentStatus(component);
});

// Update functions
function updateDashboard(data) {
    document.getElementById('total-users').textContent = data.total_users || 0;
    document.getElementById('active-sessions').textContent = data.active_sessions || 0;
    document.getElementById('daily-transactions').textContent = data.daily_transactions || 0;
    document.getElementById('system-load').textContent = data.system_load || '0%';
    document.getElementById('security-score').textContent = data.security_score || '0%';
    document.getElementById('last-backup').textContent = data.last_backup_hours || 'N/A';
    document.getElementById('update-timestamp').textContent = new Date().toLocaleString();
}

function updateSystemChart(data) {
    if (systemChart) {
        systemChart.data.labels.push(new Date().toLocaleTimeString());
        systemChart.data.datasets[0].data.push(data.cpu_usage);
        systemChart.data.datasets[1].data.push(data.memory_usage);
        systemChart.data.datasets[2].data.push(data.network_io);
        
        // Keep only last 20 data points
        if (systemChart.data.labels.length > 20) {
            systemChart.data.labels.shift();
            systemChart.data.datasets.forEach(dataset => dataset.data.shift());
        }
        
        systemChart.update('none');
    }
}

function updateUserChart(data) {
    if (userChart) {
        userChart.data.labels = data.labels;
        userChart.data.datasets[0].data = data.active_users;
        userChart.data.datasets[1].data = data.new_registrations;
        userChart.update();
    }
}

function addAlert(alert) {
    const alertContainer = document.getElementById('alert-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert-panel';
    alertDiv.innerHTML = `
        <strong><i class="fas fa-exclamation-triangle"></i> ${alert.type}:</strong> ${alert.message}
        <button class="drill-down-btn" onclick="drillDownAlert('${alert.id}')">View Details</button>
    `;
    alertContainer.appendChild(alertDiv);
}

function addRecentAction(action) {
    const tbody = document.getElementById('recent-actions');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${action.timestamp}</td>
        <td>${action.admin_user}</td>
        <td>${action.action_type}</td>
        <td>${action.target}</td>
        <td><span class="status-indicator status-${action.status}">${action.status}</span></td>
        <td><button class="drill-down-btn" onclick="drillDownAction('${action.id}')">View</button></td>
    `;
    tbody.insertBefore(row, tbody.firstChild);
    
    // Keep only latest 10 actions
    while (tbody.children.length > 10) {
        tbody.removeChild(tbody.lastChild);
    }
}

function updateComponentStatus(component) {
    const healthTable = document.getElementById('system-health');
    const existingRow = document.querySelector(`tr[data-component-id="${component.id}"]`);
    
    const rowHTML = `
        <td>${component.name}</td>
        <td><span class="status-indicator status-${component.status}">${component.status}</span></td>
        <td>${component.last_check}</td>
        <td>${component.response_time}ms</td>
        <td>${component.uptime}%</td>
        <td><button class="drill-down-btn" onclick="drillDownComponent('${component.id}')">Monitor</button></td>
    `;
    
    if (existingRow) {
        existingRow.innerHTML = rowHTML;
    } else {
        const newRow = document.createElement('tr');
        newRow.setAttribute('data-component-id', component.id);
        newRow.innerHTML = rowHTML;
        healthTable.appendChild(newRow);
    }
}

// Drill-down navigation functions
function drillDownUsers() {
    window.location.href = '/admin/users/detailed-view';
}

function drillDownSessions() {
    window.location.href = '/admin/sessions/active-monitoring';
}

function drillDownTransactions() {
    window.location.href = '/admin/transactions/daily-analysis';
}

function drillDownSystem() {
    window.location.href = '/admin/system/performance-monitor';
}

function drillDownSecurity() {
    window.location.href = '/admin/security/threat-dashboard';
}

function drillDownBackups() {
    window.location.href = '/admin/system/backup-management';
}

function drillDownAlert(alertId) {
    window.location.href = `/admin/alerts/${alertId}/investigation`;
}

function drillDownAction(actionId) {
    window.location.href = `/admin/actions/${actionId}/audit-trail`;
}

function drillDownComponent(componentId) {
    window.location.href = `/admin/system/components/${componentId}/monitor`;
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    
    // Request initial data
    if (socket.connected) {
        socket.emit('request_dashboard_data');
    }
    
    // Set up periodic data refresh
    setInterval(() => {
        if (socket.connected) {
            socket.emit('request_metrics_update');
        }
    }, 5000); // Update every 5 seconds
});
</script>
{% endblock %}