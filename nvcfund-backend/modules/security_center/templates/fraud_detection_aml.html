{% extends "base_template.html" %}

{% block title %}Fraud Detection & AML - NVC Banking Platform{% endblock %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
    .fraud-aml-dashboard {
        background: linear-gradient(135deg, #0a2447 0%, #1a365d 100%);
        min-height: 100vh;
        color: #ffffff;
        padding: 20px;
    }
    
    .fraud-header {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .fraud-metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .metric-card {
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .metric-card:hover {
        background: rgba(255,255,255,0.15);
        transform: translateY(-3px);
    }
    
    .card-suspicious { border-left: 4px solid #ff4444; }
    .card-blocked { border-left: 4px solid #ff0000; }
    .card-patterns { border-left: 4px solid #ffaa00; }
    .card-users { border-left: 4px solid #66ccff; }
    .card-transactions { border-left: 4px solid #9966ff; }
    .card-alerts { border-left: 4px solid #00ff88; }
    
    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .metric-title {
        font-weight: bold;
        font-size: 1rem;
    }
    
    .metric-icon {
        font-size: 1.5rem;
        opacity: 0.8;
    }
    
    .metric-value {
        font-size: 2.2rem;
        font-weight: bold;
        color: #66ccff;
        margin-bottom: 10px;
    }
    
    .value-critical { color: #ff4444; }
    .value-warning { color: #ffaa00; }
    .value-success { color: #00ff88; }
    
    .metric-change {
        font-size: 0.8rem;
        opacity: 0.8;
    }
    
    .change-positive { color: #00ff88; }
    .change-negative { color: #ff4444; }
    
    .pattern-analysis {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }
    
    .analysis-container {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
    }
    
    .user-behavior-profiles {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .profile-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .profile-card {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        border-left: 4px solid;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .profile-card:hover {
        background: rgba(255,255,255,0.1);
    }
    
    .profile-normal { border-left-color: #00ff88; }
    .profile-suspicious { border-left-color: #ffaa00; }
    .profile-fraudulent { border-left-color: #ff4444; }
    .profile-high-risk { border-left-color: #ff0000; }
    
    .profile-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .profile-id {
        font-weight: bold;
        color: #66ccff;
    }
    
    .risk-score {
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-left: auto;
    }
    
    .risk-low { background: #00ff88; color: #000; }
    .risk-medium { background: #ffaa00; color: #000; }
    .risk-high { background: #ff4444; color: #fff; }
    .risk-critical { background: #ff0000; color: #fff; }
    
    .profile-details {
        font-size: 0.9rem;
        margin-bottom: 10px;
    }
    
    .profile-patterns {
        font-size: 0.8rem;
        opacity: 0.8;
    }
    
    .suspicious-activities {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .activity-timeline {
        margin-top: 20px;
        max-height: 500px;
        overflow-y: auto;
    }
    
    .activity-item {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .activity-critical { border-left-color: #ff0000; }
    .activity-high { border-left-color: #ff4444; }
    .activity-medium { border-left-color: #ffaa00; }
    .activity-low { border-left-color: #66ccff; }
    
    .activity-content {
        flex: 1;
    }
    
    .activity-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .activity-details {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 5px;
    }
    
    .activity-meta {
        font-size: 0.8rem;
        opacity: 0.7;
    }
    
    .activity-actions {
        display: flex;
        gap: 5px;
    }
    
    .aml-compliance {
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 25px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        margin-bottom: 30px;
    }
    
    .compliance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .compliance-item {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
    }
    
    .compliance-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin: 0 auto 10px;
    }
    
    .status-compliant { background: #00ff88; }
    .status-warning { background: #ffaa00; }
    .status-violation { background: #ff4444; }
    
    .compliance-title {
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .compliance-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #66ccff;
        margin-bottom: 5px;
    }
    
    .compliance-description {
        font-size: 0.8rem;
        opacity: 0.8;
    }
    
    .action-btn {
        background: #66ccff;
        color: #0a2447;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: bold;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 3px;
    }
    
    .action-btn:hover {
        background: #4db8ff;
        transform: scale(1.05);
    }
    
    .action-btn.danger {
        background: #ff4444;
        color: #fff;
    }
    
    .action-btn.success {
        background: #4caf50;
        color: #fff;
    }
    
    .action-btn.warning {
        background: #ffaa00;
        color: #000;
    }
    
    .filters-section {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-input,
    .filter-select {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 8px;
        padding: 8px;
        color: #fff;
        min-width: 150px;
    }
    
    .realtime-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }
    
    .realtime-dot {
        width: 8px;
        height: 8px;
        background: #00ff88;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="fraud-aml-dashboard">
    <!-- Fraud Detection Header -->
    <div class="fraud-header">
        <div>
            <h1><i class="fas fa-user-secret"></i> Fraud Detection & Anti-Money Laundering</h1>
            <p>Advanced behavioral analytics and pattern recognition for financial crime prevention</p>
        </div>
        <div class="realtime-indicator">
            <span class="realtime-dot"></span>
            <span>Live ML Analysis</span>
        </div>
    </div>

    <!-- Fraud Metrics Grid -->
    <div class="fraud-metrics-grid">
        <div class="metric-card card-suspicious" onclick="viewSuspiciousActivities()">
            <div class="metric-header">
                <div class="metric-title">Suspicious Activities</div>
                <div class="metric-icon"><i class="fas fa-exclamation-triangle" style="color: #ff4444;"></i></div>
            </div>
            <div class="metric-value value-critical" id="suspicious-count">{{ fraud_data.suspicious_activities or 23 }}</div>
            <div class="metric-change change-positive">↑ 15% from yesterday</div>
        </div>
        
        <div class="metric-card card-blocked" onclick="viewBlockedTransactions()">
            <div class="metric-header">
                <div class="metric-title">Blocked Transactions</div>
                <div class="metric-icon"><i class="fas fa-ban" style="color: #ff0000;"></i></div>
            </div>
            <div class="metric-value value-critical" id="blocked-count">{{ fraud_data.blocked_transactions or 147 }}</div>
            <div class="metric-change change-positive">↑ 8% from yesterday</div>
        </div>
        
        <div class="metric-card card-patterns" onclick="viewUnusualPatterns()">
            <div class="metric-header">
                <div class="metric-title">Unusual Patterns</div>
                <div class="metric-icon"><i class="fas fa-search" style="color: #ffaa00;"></i></div>
            </div>
            <div class="metric-value value-warning" id="patterns-count">{{ fraud_data.unusual_patterns or 67 }}</div>
            <div class="metric-change change-negative">↓ 3% from yesterday</div>
        </div>
        
        <div class="metric-card card-users" onclick="viewHighRiskUsers()">
            <div class="metric-header">
                <div class="metric-title">High-Risk Users</div>
                <div class="metric-icon"><i class="fas fa-users" style="color: #66ccff;"></i></div>
            </div>
            <div class="metric-value" id="high-risk-users">{{ fraud_data.high_risk_users or 89 }}</div>
            <div class="metric-change change-positive">↑ 12% from yesterday</div>
        </div>
        
        <div class="metric-card card-transactions" onclick="viewTransactionAnalysis()">
            <div class="metric-header">
                <div class="metric-title">ML Flagged Txns</div>
                <div class="metric-icon"><i class="fas fa-robot" style="color: #9966ff;"></i></div>
            </div>
            <div class="metric-value" id="ml-flagged">{{ fraud_data.ml_flagged_transactions or 312 }}</div>
            <div class="metric-change change-positive">↑ 27% from yesterday</div>
        </div>
        
        <div class="metric-card card-alerts" onclick="viewAMLAlerts()">
            <div class="metric-header">
                <div class="metric-title">AML Alerts</div>
                <div class="metric-icon"><i class="fas fa-bell" style="color: #00ff88;"></i></div>
            </div>
            <div class="metric-value value-success" id="aml-alerts">{{ fraud_data.aml_alerts or 45 }}</div>
            <div class="metric-change change-negative">↓ 5% from yesterday</div>
        </div>
    </div>

    <!-- Pattern Analysis -->
    <div class="pattern-analysis">
        <div class="analysis-container">
            <h3><i class="fas fa-chart-line"></i> Fraud Pattern Analysis</h3>
            <canvas id="fraudPatternsChart" width="400" height="300"></canvas>
        </div>
        
        <div class="analysis-container">
            <h3><i class="fas fa-chart-pie"></i> Risk Distribution</h3>
            <canvas id="riskDistributionChart" width="400" height="300"></canvas>
        </div>
    </div>

    <!-- User Behavior Profiles -->
    <div class="user-behavior-profiles">
        <h3><i class="fas fa-user-chart"></i> User Behavior Profiles & Pattern Recognition</h3>
        
        <div class="filters-section">
            <input type="text" class="filter-input" id="user-search" placeholder="Search by user ID, name, or account...">
            <select class="filter-select" id="risk-filter">
                <option value="">All Risk Levels</option>
                <option value="critical">Critical Risk</option>
                <option value="high">High Risk</option>
                <option value="medium">Medium Risk</option>
                <option value="low">Low Risk</option>
            </select>
            <select class="filter-select" id="behavior-filter">
                <option value="">All Behaviors</option>
                <option value="normal">Normal Pattern</option>
                <option value="suspicious">Suspicious Activity</option>
                <option value="fraudulent">Fraudulent Behavior</option>
                <option value="anomalous">Anomalous Pattern</option>
            </select>
            <button class="action-btn" onclick="runBehaviorAnalysis()">
                <i class="fas fa-brain"></i> Run ML Analysis
            </button>
            <button class="action-btn warning" onclick="generateReport()">
                <i class="fas fa-file-alt"></i> Generate Report
            </button>
        </div>
        
        <div class="profile-grid" id="user-profiles-container">
            {% set user_profiles = [
                {
                    'user_id': 'USR-78423',
                    'name': 'Marcus Thompson',
                    'risk_level': 'critical',
                    'risk_score': 94,
                    'account_type': 'Business',
                    'anomalies': 'Unusual transaction times, geographic inconsistencies',
                    'patterns': 'Large cash deposits followed by immediate international transfers',
                    'last_activity': '2 hours ago'
                },
                {
                    'user_id': 'USR-65721',
                    'name': 'Elena Rodriguez',
                    'risk_level': 'high',
                    'risk_score': 78,
                    'account_type': 'Personal',
                    'anomalies': 'Rapid account velocity increase, multiple failed authentication',
                    'patterns': 'Login from multiple countries within 24 hours',
                    'last_activity': '45 min ago'
                },
                {
                    'user_id': 'USR-94512',
                    'name': 'David Chen',
                    'risk_level': 'medium',
                    'risk_score': 56,
                    'account_type': 'Investment',
                    'anomalies': 'Transaction amount variance, new payee additions',
                    'patterns': 'Sudden increase in high-value transactions',
                    'last_activity': '1 hour ago'
                },
                {
                    'user_id': 'USR-32184',
                    'name': 'Sarah Williams',
                    'risk_level': 'low',
                    'risk_score': 23,
                    'account_type': 'Personal',
                    'anomalies': 'None detected',
                    'patterns': 'Consistent transaction patterns, stable behavior',
                    'last_activity': '15 min ago'
                }
            ] %}
            
            {% for profile in user_profiles %}
            <div class="profile-card profile-{{ 'fraudulent' if profile.risk_score > 80 else 'suspicious' if profile.risk_score > 60 else 'normal' }}" onclick="viewUserProfile('{{ profile.user_id }}')">
                <div class="profile-header">
                    <div class="profile-id">{{ profile.user_id }}</div>
                    <div class="risk-score risk-{{ 'critical' if profile.risk_score > 80 else 'high' if profile.risk_score > 60 else 'medium' if profile.risk_score > 40 else 'low' }}">{{ profile.risk_score }%}</div>
                </div>
                <div class="profile-details">
                    <strong>{{ profile.name }}</strong> • {{ profile.account_type }} Account<br>
                    <strong>Anomalies:</strong> {{ profile.anomalies }}<br>
                    <strong>Last Activity:</strong> {{ profile.last_activity }}
                </div>
                <div class="profile-patterns">{{ profile.patterns }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Suspicious Activities Timeline -->
    <div class="suspicious-activities">
        <h3><i class="fas fa-exclamation-circle"></i> Real-time Suspicious Activities</h3>
        
        <div class="filters-section">
            <select class="filter-select" id="activity-type-filter">
                <option value="">All Activity Types</option>
                <option value="transaction">Transaction Anomaly</option>
                <option value="login">Login Pattern</option>
                <option value="velocity">Velocity Check</option>
                <option value="geographic">Geographic Anomaly</option>
                <option value="behavioral">Behavioral Change</option>
                <option value="aml">AML Flag</option>
            </select>
            <select class="filter-select" id="activity-severity-filter">
                <option value="">All Severities</option>
                <option value="critical">Critical</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
            <select class="filter-select" id="timeframe-filter">
                <option value="1h">Last Hour</option>
                <option value="24h" selected>Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
            </select>
            <button class="action-btn" onclick="refreshActivities()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
        
        <div class="activity-timeline" id="suspicious-activities-container">
            {% set suspicious_activities = [
                {
                    'title': 'Structuring Pattern Detected',
                    'severity': 'critical',
                    'user': 'USR-78423 (Marcus Thompson)',
                    'description': 'Multiple transactions just below $10,000 reporting threshold',
                    'amount': '$9,950 x 8 transactions',
                    'location': 'New York, NY',
                    'time': '15 min ago',
                    'confidence': '96%'
                },
                {
                    'title': 'Velocity Check Failed',
                    'severity': 'high',
                    'user': 'USR-65721 (Elena Rodriguez)', 
                    'description': 'Unusual transaction frequency - 47 transactions in 2 hours',
                    'amount': 'Total: $284,750',
                    'location': 'Multiple locations',
                    'time': '32 min ago',
                    'confidence': '89%'
                },
                {
                    'title': 'Geographic Anomaly',
                    'severity': 'medium',
                    'user': 'USR-94512 (David Chen)',
                    'description': 'Login from unusual location followed by large transfer',
                    'amount': '$45,000 to offshore account',
                    'location': 'Lagos, Nigeria',
                    'time': '1 hour ago',
                    'confidence': '74%'
                },
                {
                    'title': 'Behavioral Pattern Change',
                    'severity': 'high',
                    'user': 'USR-51289 (Jennifer Adams)',
                    'description': 'Sudden change in transaction patterns after 2 years of stability',
                    'amount': '$125,000 in cryptocurrency purchases',
                    'location': 'Chicago, IL',
                    'time': '2 hours ago',
                    'confidence': '82%'
                },
                {
                    'title': 'PEP Match Alert',
                    'severity': 'critical',
                    'user': 'USR-73641 (Alexander Petrov)',
                    'description': 'Customer matches Politically Exposed Person watchlist',
                    'amount': '$2,150,000 deposit',
                    'location': 'Miami, FL',
                    'time': '3 hours ago',
                    'confidence': '99%'
                }
            ] %}
            
            {% for activity in suspicious_activities %}
            <div class="activity-item activity-{{ activity.severity }}">
                <div class="activity-content">
                    <div class="activity-title">{{ activity.title }}</div>
                    <div class="activity-details">
                        <strong>User:</strong> {{ activity.user }}<br>
                        {{ activity.description }}
                    </div>
                    <div class="activity-meta">
                        <strong>Amount:</strong> {{ activity.amount }} • 
                        <strong>Location:</strong> {{ activity.location }} • 
                        <strong>Confidence:</strong> {{ activity.confidence }} • {{ activity.time }}
                    </div>
                </div>
                <div class="activity-actions">
                    <button class="action-btn" onclick="investigateActivity('{{ activity.title }}')" title="Investigate">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="action-btn warning" onclick="flagForReview('{{ activity.user }}')" title="Flag">
                        <i class="fas fa-flag"></i>
                    </button>
                    <button class="action-btn danger" onclick="blockUser('{{ activity.user }}')" title="Block">
                        <i class="fas fa-ban"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- AML Compliance Dashboard -->
    <div class="aml-compliance">
        <h3><i class="fas fa-gavel"></i> AML Compliance Dashboard</h3>
        
        <div class="compliance-grid">
            <div class="compliance-item" onclick="viewSARReports()">
                <div class="compliance-status status-compliant"></div>
                <div class="compliance-title">SAR Reports</div>
                <div class="compliance-value">{{ fraud_data.sar_reports or 12 }}</div>
                <div class="compliance-description">Filed this month</div>
            </div>
            
            <div class="compliance-item" onclick="viewCTRReports()">
                <div class="compliance-status status-compliant"></div>
                <div class="compliance-title">CTR Reports</div>
                <div class="compliance-value">{{ fraud_data.ctr_reports or 847 }}</div>
                <div class="compliance-description">Filed this month</div>
            </div>
            
            <div class="compliance-item" onclick="viewKYCStatus()">
                <div class="compliance-status status-warning"></div>
                <div class="compliance-title">KYC Compliance</div>
                <div class="compliance-value">{{ fraud_data.kyc_compliance or '94.2%' }}</div>
                <div class="compliance-description">Customer verification rate</div>
            </div>
            
            <div class="compliance-item" onclick="viewWatchlistScreening()">
                <div class="compliance-status status-compliant"></div>
                <div class="compliance-title">Watchlist Screening</div>
                <div class="compliance-value">{{ fraud_data.watchlist_hits or 23 }}</div>
                <div class="compliance-description">Matches found today</div>
            </div>
            
            <div class="compliance-item" onclick="viewRiskAssessments()">
                <div class="compliance-status status-compliant"></div>
                <div class="compliance-title">Risk Assessments</div>
                <div class="compliance-value">{{ fraud_data.risk_assessments or 156 }}</div>
                <div class="compliance-description">Completed this week</div>
            </div>
            
            <div class="compliance-item" onclick="viewAuditTrail()">
                <div class="compliance-status status-compliant"></div>
                <div class="compliance-title">Audit Trail</div>
                <div class="compliance-value">100%</div>
                <div class="compliance-description">Coverage maintained</div>
            </div>
        </div>
    </div>
</div>

<script>
// Socket.IO connection for real-time fraud detection data
const socket = io('/security-center');

// Chart instances
let fraudPatternsChart, riskDistributionChart;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    setupEventListeners();
    
    // Connect to socket for real-time updates
    if (socket.connected) {
        socket.emit('request_fraud_data');
    }
});

// Socket event handlers
socket.on('connect', function() {
    console.log('Connected to security center socket for fraud detection');
    socket.emit('request_fraud_data');
});

socket.on('fraud_activity_detected', function(activity) {
    addSuspiciousActivity(activity);
    updateFraudMetrics();
});

socket.on('user_risk_updated', function(data) {
    updateUserRiskProfile(data.user_id, data.risk_score, data.risk_level);
});

socket.on('fraud_patterns_update', function(data) {
    updateFraudPatternsChart(data);
});

socket.on('aml_alert', function(alert) {
    handleAMLAlert(alert);
});

// Initialize charts
function initializeCharts() {
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: { color: '#ffffff' }
            }
        },
        scales: {
            x: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
                ticks: { color: '#ffffff' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
        }
    };

    // Fraud Patterns Chart
    const patternsCtx = document.getElementById('fraudPatternsChart').getContext('2d');
    fraudPatternsChart = new Chart(patternsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Suspicious Activities',
                    data: [],
                    borderColor: '#ff4444',
                    backgroundColor: 'rgba(255, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Blocked Transactions',
                    data: [],
                    borderColor: '#ff0000',
                    backgroundColor: 'rgba(255, 0, 0, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'ML Detections',
                    data: [],
                    borderColor: '#9966ff',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: chartOptions
    });

    // Risk Distribution Chart
    const riskCtx = document.getElementById('riskDistributionChart').getContext('2d');
    riskDistributionChart = new Chart(riskCtx, {
        type: 'doughnut',
        data: {
            labels: ['Low Risk', 'Medium Risk', 'High Risk', 'Critical Risk'],
            datasets: [{
                data: [65, 20, 12, 3],
                backgroundColor: [
                    '#00ff88',
                    '#ffaa00',
                    '#ff4444',
                    '#ff0000'
                ],
                borderWidth: 2,
                borderColor: '#0a2447'
            }]
        },
        options: {
            ...chartOptions,
            scales: {} // Remove scales for doughnut chart
        }
    });
}

// Setup event listeners
function setupEventListeners() {
    // Filter change events
    document.getElementById('user-search').addEventListener('input', filterUserProfiles);
    document.getElementById('risk-filter').addEventListener('change', filterUserProfiles);
    document.getElementById('behavior-filter').addEventListener('change', filterUserProfiles);
    document.getElementById('activity-type-filter').addEventListener('change', filterSuspiciousActivities);
    document.getElementById('activity-severity-filter').addEventListener('change', filterSuspiciousActivities);
    document.getElementById('timeframe-filter').addEventListener('change', function() {
        const timeframe = this.value;
        socket.emit('request_fraud_data', { timeframe: timeframe });
    });
}

// Update functions
function updateFraudMetrics() {
    // Update metrics from current activity data
    const activities = document.querySelectorAll('#suspicious-activities-container .activity-item');
    const counts = { critical: 0, high: 0, medium: 0, low: 0 };
    
    activities.forEach(activity => {
        const classes = activity.className;
        if (classes.includes('activity-critical')) counts.critical++;
        else if (classes.includes('activity-high')) counts.high++;
        else if (classes.includes('activity-medium')) counts.medium++;
        else if (classes.includes('activity-low')) counts.low++;
    });
    
    const total = counts.critical + counts.high + counts.medium + counts.low;
    document.getElementById('suspicious-count').textContent = total;
}

function updateFraudPatternsChart(data) {
    if (fraudPatternsChart && data.labels) {
        fraudPatternsChart.data.labels = data.labels;
        fraudPatternsChart.data.datasets[0].data = data.suspicious || [];
        fraudPatternsChart.data.datasets[1].data = data.blocked || [];
        fraudPatternsChart.data.datasets[2].data = data.ml_detections || [];
        fraudPatternsChart.update('none');
    }
}

function addSuspiciousActivity(activity) {
    const container = document.getElementById('suspicious-activities-container');
    const item = document.createElement('div');
    item.className = `activity-item activity-${activity.severity}`;
    item.innerHTML = `
        <div class="activity-content">
            <div class="activity-title">${activity.title}</div>
            <div class="activity-details">
                <strong>User:</strong> ${activity.user}<br>
                ${activity.description}
            </div>
            <div class="activity-meta">
                <strong>Amount:</strong> ${activity.amount} • 
                <strong>Location:</strong> ${activity.location} • 
                <strong>Confidence:</strong> ${activity.confidence} • ${activity.time}
            </div>
        </div>
        <div class="activity-actions">
            <button class="action-btn" onclick="investigateActivity('${activity.title}')" title="Investigate">
                <i class="fas fa-search"></i>
            </button>
            <button class="action-btn warning" onclick="flagForReview('${activity.user}')" title="Flag">
                <i class="fas fa-flag"></i>
            </button>
            <button class="action-btn danger" onclick="blockUser('${activity.user}')" title="Block">
                <i class="fas fa-ban"></i>
            </button>
        </div>
    `;
    
    container.insertBefore(item, container.firstChild);
    
    // Keep only latest 20 activities
    while (container.children.length > 20) {
        container.removeChild(container.lastChild);
    }
}

function updateUserRiskProfile(userId, riskScore, riskLevel) {
    const profiles = document.querySelectorAll('#user-profiles-container .profile-card');
    profiles.forEach(profile => {
        const profileId = profile.querySelector('.profile-id').textContent;
        if (profileId === userId) {
            const riskScoreElement = profile.querySelector('.risk-score');
            riskScoreElement.textContent = riskScore + '%';
            riskScoreElement.className = `risk-score risk-${riskLevel}`;
            
            // Update profile card border
            profile.className = `profile-card profile-${riskLevel === 'critical' ? 'fraudulent' : riskLevel === 'high' ? 'suspicious' : 'normal'}`;
        }
    });
}

function handleAMLAlert(alert) {
    // Handle incoming AML alerts
    addSuspiciousActivity({
        title: 'AML Alert: ' + alert.type,
        severity: alert.severity,
        user: alert.user,
        description: alert.description,
        amount: alert.amount,
        location: alert.location,
        time: 'Just now',
        confidence: alert.confidence
    });
    
    // Update AML alerts counter
    const alertsElement = document.getElementById('aml-alerts');
    const currentCount = parseInt(alertsElement.textContent);
    alertsElement.textContent = currentCount + 1;
}

// Navigation functions
function viewSuspiciousActivities() {
    window.location.href = '/security/fraud/suspicious-activities';
}

function viewBlockedTransactions() {
    window.location.href = '/security/fraud/blocked-transactions';
}

function viewUnusualPatterns() {
    window.location.href = '/security/fraud/unusual-patterns';
}

function viewHighRiskUsers() {
    window.location.href = '/security/fraud/high-risk-users';
}

function viewTransactionAnalysis() {
    window.location.href = '/security/fraud/transaction-analysis';
}

function viewAMLAlerts() {
    window.location.href = '/security/aml/alerts';
}

function viewUserProfile(userId) {
    window.location.href = `/security/fraud/user-profile/${userId}`;
}

// AML Compliance navigation
function viewSARReports() {
    window.location.href = '/security/aml/sar-reports';
}

function viewCTRReports() {
    window.location.href = '/security/aml/ctr-reports';
}

function viewKYCStatus() {
    window.location.href = '/security/aml/kyc-status';
}

function viewWatchlistScreening() {
    window.location.href = '/security/aml/watchlist-screening';
}

function viewRiskAssessments() {
    window.location.href = '/security/aml/risk-assessments';
}

function viewAuditTrail() {
    window.location.href = '/security/aml/audit-trail';
}

// Action functions
function investigateActivity(activityTitle) {
    window.location.href = `/security/fraud/investigate?activity=${encodeURIComponent(activityTitle)}`;
}

function flagForReview(userId) {
    if (confirm(`Flag ${userId} for manual review? This will add the user to the review queue.`)) {
        fetch('/security/api/fraud/flag-user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_id: userId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User flagged for review successfully');
            } else {
                alert('Error flagging user: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error flagging user');
        });
    }
}

function blockUser(userId) {
    if (confirm(`Block ${userId}? This will immediately suspend all account access.`)) {
        fetch('/security/api/fraud/block-user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_id: userId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User blocked successfully');
            } else {
                alert('Error blocking user: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error blocking user');
        });
    }
}

function runBehaviorAnalysis() {
    if (confirm('Run comprehensive ML behavior analysis? This may take several minutes.')) {
        fetch('/security/api/fraud/behavior-analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Behavior analysis started. Analyzing ${data.user_count} user profiles.`);
            } else {
                alert('Error starting analysis: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error starting behavior analysis');
        });
    }
}

function generateReport() {
    const reportType = prompt('Report type:\n1. Fraud Summary\n2. AML Compliance\n3. Risk Assessment\n4. User Behavior\n\nEnter number:');
    if (reportType && reportType >= 1 && reportType <= 4) {
        const reportTypes = ['fraud-summary', 'aml-compliance', 'risk-assessment', 'user-behavior'];
        window.location.href = `/security/fraud/reports/${reportTypes[reportType - 1]}`;
    }
}

// Filter functions
function filterUserProfiles() {
    const search = document.getElementById('user-search').value.toLowerCase();
    const riskFilter = document.getElementById('risk-filter').value;
    const behaviorFilter = document.getElementById('behavior-filter').value;
    
    const profiles = document.querySelectorAll('#user-profiles-container .profile-card');
    profiles.forEach(profile => {
        const text = profile.textContent.toLowerCase();
        const riskScore = parseInt(profile.querySelector('.risk-score').textContent);
        const riskLevel = riskScore > 80 ? 'critical' : riskScore > 60 ? 'high' : riskScore > 40 ? 'medium' : 'low';
        
        const matchesSearch = !search || text.includes(search);
        const matchesRisk = !riskFilter || riskLevel === riskFilter;
        const matchesBehavior = !behaviorFilter || text.includes(behaviorFilter);
        
        profile.style.display = matchesSearch && matchesRisk && matchesBehavior ? '' : 'none';
    });
}

function filterSuspiciousActivities() {
    const typeFilter = document.getElementById('activity-type-filter').value;
    const severityFilter = document.getElementById('activity-severity-filter').value;
    
    const activities = document.querySelectorAll('#suspicious-activities-container .activity-item');
    activities.forEach(activity => {
        const text = activity.textContent.toLowerCase();
        const classes = activity.className;
        
        const matchesType = !typeFilter || text.includes(typeFilter);
        const matchesSeverity = !severityFilter || classes.includes(`activity-${severityFilter}`);
        
        activity.style.display = matchesType && matchesSeverity ? '' : 'none';
    });
}

function refreshActivities() {
    const timeframe = document.getElementById('timeframe-filter').value;
    socket.emit('request_fraud_data', { timeframe: timeframe });
}
</script>
{% endblock %}