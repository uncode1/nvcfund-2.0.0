{% extends "interest_rate_management/layout.html" %}

{% block title %}Interest Rate Management Dashboard{% endblock %}

{% block content %}
<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-white">
            <i class="fas fa-percent text-primary me-2"></i>
            Interest Rate Management
        </h1>
        <div class="text-white-50">
            <i class="fas fa-university me-1"></i>
            Fed Funds Rate: {{ "%.2f"|format(central_bank_rates.policy_rates.federal_funds_rate.current_rate) }%}
        </div>
    </div>

    <!-- Central Bank Rates Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-university me-2"></i>
                        Federal Funds Rate
                    </h6>
                </div>
                <div class="card-body text-center">
                    <h2 class="text-primary">{{ "%.2f"|format(central_bank_rates.policy_rates.federal_funds_rate.current_rate) }%}</h2>
                    <small class="text-muted">Target: {{ central_bank_rates.policy_rates.federal_funds_rate.target_range }}</small>
                    <div class="mt-2">
                        <span class="badge bg-{{ 'success' if central_bank_rates.policy_rates.federal_funds_rate.change_amount > 0 else 'danger' }}">
                            {{ "+" if central_bank_rates.policy_rates.federal_funds_rate.change_amount > 0 else "" }}{{ "%.2f"|format(central_bank_rates.policy_rates.federal_funds_rate.change_amount) }%}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        10-Year Treasury
                    </h6>
                </div>
                <div class="card-body text-center">
                    <h2 class="text-success">{{ "%.2f"|format(central_bank_rates.benchmark_rates.treasury_yields['10_year']) }%}</h2>
                    <small class="text-muted">Benchmark Rate</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-clock me-2"></i>
                        SOFR Overnight
                    </h6>
                </div>
                <div class="card-body text-center">
                    <h2 class="text-info">{{ "%.2f"|format(central_bank_rates.benchmark_rates.sofr.overnight) }%}</h2>
                    <small class="text-muted">Secured Overnight</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0">
                <div class="card-header bg-warning text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-window-restore me-2"></i>
                        Discount Window
                    </h6>
                </div>
                <div class="card-body text-center">
                    <h2 class="text-warning">{{ "%.2f"|format(central_bank_rates.policy_rates.discount_window.primary_credit) }%}</h2>
                    <small class="text-muted">Primary Credit</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Rate Setting Authority -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-shield me-2"></i>
                        Your Rate Authority
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">Authorized Products</h6>
                        <div class="row">
                            {% for level, details in rate_authority.authorization_levels.items() %}
                            <div class="col-6 mb-2">
                                <div class="p-2 border rounded">
                                    <div class="fw-bold">{{ level.replace('_', ' ').title() }}</div>
                                    <small class="text-muted">{{ details.description }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#rateChangeModal">
                            <i class="fas fa-edit me-2"></i>
                            Propose Rate Change
                        </button>
                        <a href="{{ url_for('interest_rate_management.rate_history') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-history me-2"></i>
                            Rate History
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        Current Prime Rate
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <h1 class="display-4 text-success">8.25%</h1>
                        <p class="text-muted">Prime Lending Rate</p>
                    </div>
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="text-center p-2 border rounded">
                                <small class="text-muted">Formula</small>
                                <div class="fw-bold">Fed Funds + 3.00%</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 border rounded">
                                <small class="text-muted">Last Change</small>
                                <div class="fw-bold">{{ central_bank_rates.policy_rates.federal_funds_rate.last_change }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lending vs Deposit Rates Comparison -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-0">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-hand-holding-usd me-2"></i>
                        Key Lending Rates
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">30-Year Mortgage (Prime):</span>
                            <span class="fw-bold">{{ "%.2f"|format(lending_rates.consumer_lending.mortgage_rates['30_year_fixed'].prime_rate) }%}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Personal Loan (Excellent):</span>
                            <span class="fw-bold">{{ "%.2f"|format(lending_rates.consumer_lending.personal_loans.unsecured.excellent_credit) }%}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Auto Loan (New):</span>
                            <span class="fw-bold">{{ "%.2f"|format(lending_rates.consumer_lending.auto_loans.new_vehicles.excellent_credit) }%}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Business Term Loan:</span>
                            <span class="fw-bold">{{ "%.2f"|format(lending_rates.commercial_lending.business_loans.conventional.term_loans) }%}</span>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Credit Cards (Prime):</span>
                            <span class="fw-bold">{{ "%.2f"|format(lending_rates.consumer_lending.credit_cards.prime_cards) }%}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-piggy-bank me-2"></i>
                        Key Deposit Rates
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">High-Yield Savings:</span>
                            <span class="fw-bold">{{ "%.2f"|format(deposit_rates.consumer_deposits.savings_accounts.high_yield_savings.promotional_rate) }%}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Money Market:</span>
                            <span class="fw-bold">{{ "%.2f"|format(deposit_rates.consumer_deposits.savings_accounts.money_market.base_rate) }%}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">1-Year CD:</span>
                            <span class="fw-bold">{{ "%.2f"|format(deposit_rates.consumer_deposits.certificates_of_deposit.standard_cds['1_year']) }%}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Business Money Market:</span>
                            <span class="fw-bold">{{ "%.2f"|format(deposit_rates.commercial_deposits.business_savings.business_money_market) }%}</span>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Regular Savings:</span>
                            <span class="fw-bold">{{ "%.2f"|format(deposit_rates.consumer_deposits.savings_accounts.regular_savings.base_rate) }%}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Rate Management Tools
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <a href="{{ url_for('interest_rate_management.lending_rates') }}" class="btn btn-outline-warning w-100 mb-2">
                                <i class="fas fa-hand-holding-usd me-2"></i>
                                Lending Rates
                            </a>
                        </div>
                        <div class="col-md-2">
                            <a href="{{ url_for('interest_rate_management.deposit_rates') }}" class="btn btn-outline-info w-100 mb-2">
                                <i class="fas fa-piggy-bank me-2"></i>
                                Deposit Rates
                            </a>
                        </div>
                        <div class="col-md-2">
                            <a href="{{ url_for('interest_rate_management.rate_history') }}" class="btn btn-outline-secondary w-100 mb-2">
                                <i class="fas fa-history me-2"></i>
                                Rate History
                            </a>
                        </div>
                        <div class="col-md-2">
                            <a href="{{ url_for('interest_rate_management.rate_algorithms') }}" class="btn btn-outline-success w-100 mb-2">
                                <i class="fas fa-robot me-2"></i>
                                Algorithms
                            </a>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary w-100 mb-2" onclick="openRateCalculator()">
                                <i class="fas fa-calculator me-2"></i>
                                Calculator
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-danger w-100 mb-2" data-bs-toggle="modal" data-bs-target="#emergencyRateModal">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Emergency
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rate Change Proposal Modal -->
<div class="modal fade" id="rateChangeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title text-white">
                    <i class="fas fa-edit me-2"></i>
                    Propose Rate Change
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="rateChangeForm">
                    <div class="mb-3">
                        <label class="form-label text-white">Product Category</label>
                        <select class="form-control" id="productCategory" required>
                            <option value="">Select Product Category</option>
                            <option value="consumer_deposits">Consumer Deposits</option>
                            <option value="consumer_lending">Consumer Lending</option>
                            <option value="commercial_lending">Commercial Lending</option>
                            <option value="institutional_lending">Institutional Lending</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white">Current Rate (%)</label>
                        <input type="number" class="form-control" id="currentRate" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white">Proposed Rate (%)</label>
                        <input type="number" class="form-control" id="proposedRate" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white">Effective Date</label>
                        <input type="date" class="form-control" id="effectiveDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white">Justification</label>
                        <textarea class="form-control" id="justification" rows="3" required 
                                  placeholder="Provide business justification for the rate change..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitRateChange()">
                    <i class="fas fa-paper-plane me-2"></i>
                    Submit Proposal
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rate Calculator Modal -->
<div class="modal fade" id="rateCalculatorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title text-white">
                    <i class="fas fa-calculator me-2"></i>
                    Rate Change Impact Calculator
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="calculatorForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label text-white">Product Type</label>
                                <select class="form-control" id="calcProductType" required>
                                    <option value="savings">Savings Account</option>
                                    <option value="cd">Certificate of Deposit</option>
                                    <option value="mortgage">Mortgage</option>
                                    <option value="personal_loan">Personal Loan</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-white">Current Rate (%)</label>
                                <input type="number" class="form-control" id="calcCurrentRate" step="0.01" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-white">Proposed Rate (%)</label>
                                <input type="number" class="form-control" id="calcProposedRate" step="0.01" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-white">Portfolio Amount ($)</label>
                                <input type="number" class="form-control" id="calcPortfolioAmount" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="calculationResults" class="border rounded p-3" style="display: none;">
                                <h6 class="text-white mb-3">Impact Analysis</h6>
                                <div class="mb-2">
                                    <span class="text-muted">Rate Change:</span>
                                    <span class="fw-bold" id="rateChange">0.00%</span>
                                </div>
                                <div class="mb-2">
                                    <span class="text-muted">Annual Revenue Impact:</span>
                                    <span class="fw-bold" id="annualImpact">$0</span>
                                </div>
                                <div class="mb-2">
                                    <span class="text-muted">Monthly Impact:</span>
                                    <span class="fw-bold" id="monthlyImpact">$0</span>
                                </div>
                                <div class="mb-2">
                                    <span class="text-muted">Customer Impact (per $100):</span>
                                    <span class="fw-bold" id="customerImpact">$0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="calculateImpact()">
                    <i class="fas fa-calculator me-2"></i>
                    Calculate Impact
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function openRateCalculator() {
    $('#rateCalculatorModal').modal('show');
}

function calculateImpact() {
    const currentRate = parseFloat(document.getElementById('calcCurrentRate').value) || 0;
    const proposedRate = parseFloat(document.getElementById('calcProposedRate').value) || 0;
    const portfolioAmount = parseFloat(document.getElementById('calcPortfolioAmount').value) || 0;
    
    if (currentRate && proposedRate && portfolioAmount) {
        const rateChange = proposedRate - currentRate;
        const annualImpact = (rateChange / 100) * portfolioAmount;
        const monthlyImpact = annualImpact / 12;
        const customerImpact = rateChange;
        
        document.getElementById('rateChange').textContent = (rateChange >= 0 ? '+' : '') + rateChange.toFixed(2) + '%';
        document.getElementById('annualImpact').textContent = '$' + annualImpact.toLocaleString();
        document.getElementById('monthlyImpact').textContent = '$' + monthlyImpact.toLocaleString();
        document.getElementById('customerImpact').textContent = '$' + customerImpact.toFixed(2);
        
        document.getElementById('calculationResults').style.display = 'block';
    }
}

function submitRateChange() {
    const formData = {
        product_category: document.getElementById('productCategory').value,
        current_rate: parseFloat(document.getElementById('currentRate').value),
        proposed_rate: parseFloat(document.getElementById('proposedRate').value),
        effective_date: document.getElementById('effectiveDate').value,
        justification: document.getElementById('justification').value
    };
    
    // Mock submission
    alert('Rate change proposal submitted for review. Proposal ID: PROP-' + Math.floor(Math.random() * 10000));
    $('#rateChangeModal').modal('hide');
}
</script>
{% endblock %}