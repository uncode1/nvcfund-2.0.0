{% extends "auth/layout.html" %}

{% block title %}KYC Verification Dashboard - NVC Banking Platform{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-shield-alt text-primary"></i>
                KYC Identity Verification
            </h2>
            
            <!-- Service Status -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i>
                                Verification Service Status
                            </h5>
                            <span class="badge {% if service_status.available %}badge-success{% else %}badge-warning{% endif %}">
                                {% if service_status.available %}
                                    <i class="fas fa-check-circle"></i> Available
                                {% else %}
                                    <i class="fas fa-exclamation-triangle"></i> Limited
                                {% endif %}
                            </span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6>Environment</h6>
                                    <p class="text-muted">{{ service_status.environment|upper }}</p>
                                </div>
                                <div class="col-md-3">
                                    <h6>Supported Countries</h6>
                                    <p class="text-muted">{{ service_status.supported_countries }} countries</p>
                                </div>
                                <div class="col-md-3">
                                    <h6>SDK Status</h6>
                                    <p class="text-muted">
                                        {% if service_status.plaid_sdk_installed %}
                                            <i class="fas fa-check text-success"></i> Installed
                                        {% else %}
                                            <i class="fas fa-times text-danger"></i> Not Installed
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-md-3">
                                    <h6>Configuration</h6>
                                    <p class="text-muted">
                                        {% if service_status.credentials_configured and service_status.template_configured %}
                                            <i class="fas fa-check text-success"></i> Complete
                                        {% else %}
                                            <i class="fas fa-exclamation text-warning"></i> Incomplete
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Feature List -->
                            <div class="mt-3">
                                <h6>Available Features</h6>
                                <div class="row">
                                    {% for feature, enabled in service_status.features.items() %}
                                    <div class="col-md-4">
                                        <span class="{% if enabled %}text-success{% else %}text-muted{% endif %}">
                                            <i class="fas {% if enabled %}fa-check{% else %}fa-times{% endif %}"></i>
                                            {{ feature.replace('_', ' ').title() }}
                                        </span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Start New Verification -->
            {% if service_status.available %}
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-plus-circle"></i>
                                Start Identity Verification
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                Complete your identity verification using Plaid's secure verification process. 
                                This includes document verification, selfie verification, and data source checks.
                            </p>
                            
                            <form id="kycForm" class="row g-3">
                                <div class="col-md-6">
                                    <label for="given_name" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="given_name" name="given_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="family_name" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="family_name" name="family_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="date_of_birth" class="form-label">Date of Birth *</label>
                                    <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="phone_number" class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                           placeholder="+1234567890" required>
                                </div>
                                <div class="col-12">
                                    <label for="street" class="form-label">Street Address *</label>
                                    <input type="text" class="form-control" id="street" name="street" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="city" class="form-label">City *</label>
                                    <input type="text" class="form-control" id="city" name="city" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="region" class="form-label">State/Region *</label>
                                    <input type="text" class="form-control" id="region" name="region" 
                                           placeholder="CA" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="postal_code" class="form-label">ZIP/Postal Code *</label>
                                    <input type="text" class="form-control" id="postal_code" name="postal_code" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="country" class="form-label">Country *</label>
                                    <select class="form-control" id="country" name="country" required>
                                        <option value="">Select Country</option>
                                        {% for country in supported_countries %}
                                        <option value="{{ country }}" {% if country == 'US' %}selected{% endif %}>
                                            {{ country }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="consent" name="consent" required>
                                        <label class="form-check-label" for="consent">
                                            I consent to identity verification and agree to share my information with Plaid for verification purposes.
                                        </label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary" id="startVerification">
                                        <i class="fas fa-shield-alt"></i>
                                        Start Verification
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="startLinkToken" style="display:none;">
                                        <i class="fas fa-external-link-alt"></i>
                                        Open Verification Link
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Verification History -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history"></i>
                                Verification History
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if verifications %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Completed</th>
                                            <th>Score</th>
                                            <th>Verification Details</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for verification in verifications %}
                                        <tr>
                                            <td>
                                                <code>{{ verification.plaid_verification_id[:8] }}...</code>
                                            </td>
                                            <td>
                                                {% if verification.status.value == 'success' %}
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-check"></i> Success
                                                    </span>
                                                {% elif verification.status.value == 'failed' %}
                                                    <span class="badge badge-danger">
                                                        <i class="fas fa-times"></i> Failed
                                                    </span>
                                                {% elif verification.status.value == 'pending' %}
                                                    <span class="badge badge-warning">
                                                        <i class="fas fa-clock"></i> Pending
                                                    </span>
                                                {% elif verification.status.value == 'in_progress' %}
                                                    <span class="badge badge-info">
                                                        <i class="fas fa-spinner"></i> In Progress
                                                    </span>
                                                {% else %}
                                                    <span class="badge badge-secondary">
                                                        {{ verification.status.value.replace('_', ' ').title() }}
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ verification.created_at.strftime('%Y-%m-%d %H:%M') if verification.created_at else '-' }}
                                            </td>
                                            <td>
                                                {{ verification.completed_at.strftime('%Y-%m-%d %H:%M') if verification.completed_at else '-' }}
                                            </td>
                                            <td>
                                                {% if verification.overall_score %}
                                                    <span class="{% if verification.overall_score >= 0.8 %}text-success{% elif verification.overall_score >= 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                                        {{ "%.1f"|format(verification.overall_score * 100) }%}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="verification-details">
                                                    {% if verification.document_verified %}
                                                        <i class="fas fa-id-card text-success" title="Document Verified"></i>
                                                    {% else %}
                                                        <i class="fas fa-id-card text-muted" title="Document Not Verified"></i>
                                                    {% endif %}
                                                    
                                                    {% if verification.selfie_verified %}
                                                        <i class="fas fa-user-circle text-success ml-1" title="Selfie Verified"></i>
                                                    {% else %}
                                                        <i class="fas fa-user-circle text-muted ml-1" title="Selfie Not Verified"></i>
                                                    {% endif %}
                                                    
                                                    {% if verification.data_sources_verified %}
                                                        <i class="fas fa-database text-success ml-1" title="Data Sources Verified"></i>
                                                    {% else %}
                                                        <i class="fas fa-database text-muted ml-1" title="Data Sources Not Verified"></i>
                                                    {% endif %}
                                                    
                                                    {% if verification.kyc_passed %}
                                                        <i class="fas fa-shield-alt text-success ml-1" title="KYC Passed"></i>
                                                    {% else %}
                                                        <i class="fas fa-shield-alt text-muted ml-1" title="KYC Not Passed"></i>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary refresh-status" 
                                                        data-verification-id="{{ verification.plaid_verification_id }}">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                                {% if verification.shareable_url and not verification.is_complete() %}
                                                <a href="{{ verification.shareable_url }}" target="_blank" 
                                                   class="btn btn-sm btn-outline-success ml-1">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-shield-alt fa-3x mb-3"></i>
                                <h5>No Verifications Yet</h5>
                                <p>Start your first identity verification to ensure account security and compliance.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status update alerts -->
<div id="statusAlerts"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('kycForm');
    const startBtn = document.getElementById('startVerification');
    const linkBtn = document.getElementById('startLinkToken');
    const refreshBtns = document.querySelectorAll('.refresh-status');
    
    let linkToken = null;
    
    function showAlert(message, type = 'info') {
        const alertsContainer = document.getElementById('statusAlerts');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        `;
        alertsContainer.appendChild(alertDiv);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 5000);
    }
    
    if (startBtn) {
        startBtn.addEventListener('click', function() {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // Validate required fields
            const requiredFields = ['given_name', 'family_name', 'date_of_birth', 'phone_number', 'street', 'city', 'region', 'postal_code', 'country'];
            for (const field of requiredFields) {
                if (!data[field]) {
                    showAlert(`Please fill in the ${field.replace('_', ' ')} field.`, 'warning');
                    return;
                }
            }
            
            if (!data.consent) {
                showAlert('Please provide consent for identity verification.', 'warning');
                return;
            }
            
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Verification...';
            
            // Create verification
            fetch('/auth/kyc/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Verification session created successfully!', 'success');
                    
                    if (result.shareable_url) {
                        // Open verification in new window
                        window.open(result.shareable_url, '_blank');
                        showAlert('Verification window opened. Complete the process and return here.', 'info');
                    }
                    
                    // Refresh page to show updated status
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert(result.error || 'Failed to create verification session.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Network error occurred. Please try again.', 'danger');
            })
            .finally(() => {
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Start Verification';
            });
        });
    }
    
    // Refresh status buttons
    refreshBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const verificationId = this.dataset.verificationId;
            const originalContent = this.innerHTML;
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            fetch(`/auth/kyc/status/${verificationId}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Status updated successfully!', 'success');
                    // Refresh page to show updated status
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert(result.error || 'Failed to refresh status.', 'warning');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Failed to refresh status.', 'danger');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = originalContent;
            });
        });
    });
});
</script>

<style>
.verification-details i {
    font-size: 1.2em;
}

.card {
    border: none;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.badge {
    font-size: 0.9em;
}

.table td {
    vertical-align: middle;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
}
</style>

{% endblock %}